<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Tools</title>
    <link rel="icon" href="/minecraft/favicon.ico" type="image/x-icon">

    <style>
        /* --- Minecraft theme variables ---
           These CSS variables control the color/theme across the UI.
           Changing them updates the entire look consistently. */
        @font-face {
            font-family: 'Minecraft';
            src: url('/minecraft/fonts/Minecraft-Font.ttf') format('truetype');
        }

        :root {
            --bg: #3c6e71;
            --panel: #222;
            --panel-2: #333;
            --border: #555;
            --border-strong: #888;
            --text: #fff;
            --text-dim: #ddd;
            --btn: #444;
            --btn-hover: #666;
            --btn-primary: #2d8a34;
            --btn-primary-hover: #3da544;
            --overlay: rgba(0, 0, 0, 0.6);
            --input-bg: #111;
        }

        /* Basic reset / box sizing */
        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: 'Minecraft', monospace;
            color: var(--text);
            background: var(--bg);
        }

        /* Container */
        .admin-shell {
            width: min(1200px, 95vw);
            height: 75vh;
            margin: 4vh auto;
            /* panel gradient for subtle depth */
            background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
            border: 4px solid var(--border);
            padding: 18px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        /* Header area with centered title and "Add" button positioned absolutely */
        header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 28px;
            margin: 0;
            padding-bottom: 6px;
            border-bottom: 3px solid var(--border-strong);
            position: relative;
        }

        /* 'Add' button in header (absolute so title stays centered) */
        .add-tool-btn {
            position: absolute;
            left: 16px;
            top: 8px;
            padding: 6px 10px;
            border: 3px solid var(--border-strong);
            background: var(--btn-primary);
            color: var(--text);
            cursor: pointer;
            font-family: 'Minecraft';
        }

        /* Scrollable area that contains tool cards */
        .tools-area {
            flex: 1 1 auto;
            overflow: auto;
            padding: 12px;
            margin-top: 6px;
        }

        /* Responsive grid for tool cards */
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
            align-items: start;
        }

        /* Individual tool card styles */
        .tool-card {
            background: var(--panel-2);
            border: 3px solid var(--border);
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 220px;
            max-height: 100%;
            font-family: 'Minecraft';
        }

        .tool-title {
            text-align: center;
            font-size: 18px;
            margin: 2px 0 10px 0;
        }

        .tool-body {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-size: 13px;
        }

        /* Inputs / selects / textarea base styles */
        input,
        select,
        textarea {
            background: var(--input-bg);
            color: var(--text);
            border: 3px solid var(--border);
            padding: 8px;
            font-family: 'Minecraft';
            font-size: 14px;
            outline: none;
            width: 100%;
        }

        .spacer {
            flex: 1 1 auto;
        }

        /* Submit button for each tool card */
        .submit-btn {
            display: block;
            width: 100%;
            text-align: center;
            padding: 8px 12px;
            font-family: 'Minecraft';
            font-size: 16px;
            border: 3px solid var(--border-strong);
            background: var(--btn);
            cursor: pointer;
        }

        .submit-btn:hover {
            background: var(--btn-hover);
        }

        /* Message area under each card (success/error) */
        .card-message {
            font-size: 13px;
            margin-top: 8px;
            color: var(--text-dim);
            min-height: 1.2em;
        }

        .card-message.error {
            color: #ff6b6b;
            font-weight: bold;
        }

        /* Confirm overlay: shown when running a tool (asks user to confirm inputs) */
        .confirm-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: var(--overlay);
            z-index: 7000;
            /* high so it's above editor */
        }

        .confirm-overlay.active {
            display: flex;
        }

        .confirm-modal {
            width: clamp(280px, 46vw, 560px);
            background: var(--panel);
            border: 4px solid var(--border);
            padding: 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7);
            font-family: 'Minecraft';
        }

        .confirm-title {
            text-align: center;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .confirm-body {
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 12px;
        }

        .confirm-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            padding: 8px 12px;
            border: 3px solid var(--border-strong);
            background: var(--btn);
            color: var(--text);
            cursor: pointer;
            font-family: 'Minecraft';
        }

        .btn.primary {
            background: var(--btn-primary);
            border-color: var(--btn-primary-hover);
        }

        /* Editor overlay: used to add/edit tools (inputs are added horizontally) */
        .editor-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            overflow: hidden;
        }

        .editor-overlay.active {
            display: flex;
        }

        .editor {
            width: min(1000px, 94vw);
            max-width: 1100px;
            height: 480px;
            background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
            border: 4px solid var(--border);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
            overflow: hidden;
            font-family: 'Minecraft';
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
        }

        .editor .top-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .editor .top-row>* {
            flex: 1 1 auto;
        }

        .editor .top-row input {
            width: 100%;
        }

        /* Viewport for the horizontally scrollable list of input definitions */
        .inputs-viewport {
            flex: 1 1 auto;
            min-height: 300px;
            border: 3px solid var(--border);
            padding: 8px;
            position: relative;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.06);
        }

        /* horizontal rail that holds the input cards */
        .inputs-scroll {
            display: flex;
            gap: 12px;
            align-items: stretch;
            height: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 8px;
            padding-top: 6px;
        }

        /* single input card inside editor (label/key/type + remove) */
        .input-card {
            min-width: 220px;
            max-width: 260px;
            background: var(--panel-2);
            border: 3px solid var(--border);
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: fit-content;
            align-self: start;
            font-family: 'Minecraft';
        }

        .input-card .mini-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .input-card .mini-row input,
        .input-card select {
            font-size: 13px;
            font-family: 'Minecraft';
        }

        .input-card .remove-input {
            padding: 4px 8px;
            border: 3px solid var(--border);
            background: #5a2626;
            cursor: pointer;
            color: var(--text);
            font-family: Minecraft;
        }

        /* Editor footer — add input button is on the left now */
        .editor-footer {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            /* left area for Add and right area for Cancel/Save */
            align-items: center;
        }

        .editor-footer .left-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .editor-footer .right-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .editor-footer .btn {
            min-width: 100px;
        }

        code {
            font-family: 'Minecraft', monospace;
        }

        /* Small viewport tweaks */
        @media (max-width:640px) {
            .editor {
                height: 640px;
                width: 92vw;
            }

            .input-card {
                min-width: 180px;
            }

            .inputs-viewport {
                min-height: 240px;
            }
        }
    </style>

</head>

<body>
    <div id="root"></div>

    <!-- Editor overlay (hidden by default). Shows UI for adding a new tool and its inputs -->
    <div id="editorOverlay" class="editor-overlay" aria-hidden="true">
        <div class="editor" role="dialog" aria-modal="true" aria-label="Add Tool Editor">

            <div class="top-row">
                <div>
                    <label for="toolName">Name</label>
                    <input id="toolName" placeholder="Tool name (eg. Reset Password)" />
                </div>
                <div>
                    <label for="toolAction">Action</label>
                    <input id="toolAction" placeholder="Global function name to call (eg. newPassword)" />
                </div>
            </div>

            <!-- inputsViewport will contain a horizontally scrollable list of input-cards -->
            <div class="inputs-viewport" id="inputsViewport" aria-label="Inputs area">
                <div class="inputs-scroll" id="inputsScroll"></div>
            </div>

            <div class="editor-footer">
                <div class="left-actions">
                    <button class="btn" id="editorAddInput">+ Add input</button>
                </div>

                <div class="right-actions">
                    <button class="btn" id="editorCancel">Cancel</button>
                    <button class="btn primary" id="editorSave">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation overlay used both for running a tool and for confirming adding a new tool -->
    <div id="saveConfirm" class="confirm-overlay" aria-hidden="true">
        <div class="confirm-modal" role="dialog" aria-modal="true">
            <div class="confirm-title">Are you sure?</div>
            <div class="confirm-body" id="saveConfirmBody"></div>
            <div class="confirm-actions">
                <button class="btn" id="confirmNo">Cancel</button>
                <button class="btn primary" id="confirmYes">Add tool</button>
            </div>
        </div>

        <script src="../index.js"></script>
        <script src="adminTools.js"></script>
    </div>

    <script>
        (async function () {
            // -------------------------
            // Initial/default tool list
            // -------------------------
            // starts with one example tool to show the UI before admin check resolves.
            let tools = [{
                name: "Reset Password",
                inputs: [
                    {
                        key: "mcusername",
                        label: "MC Username", type: "text"
                    },
                    {
                        key: "newPassword",
                        label: "New Password", type: "password"
                    }
                ],
                action: "newPassword"
            }];

            const root = document.getElementById('root');
            // show a temporary loading state while checking admin (getAdmin may replace tools)
            root.innerHTML = `<div class=admin-shell><header>Admin Tools</header><div class=tools-area style="display:flex;align-items:center;justify-content:center;color:var(--text-dim)">Checking permissions…</div></div>`;

            // If a global getAdmin function exists (provided by host), call it to get server-provided tools.
            // We await it in case it returns a Promise.
            try { if (typeof getAdmin === 'function') tools = await getAdmin(); } catch (e) { console.warn('getAdmin failed', e) }

            // Render the full page now that we have a tools list (or null if unauthorized)
            renderPage();

            // -------------------------
            // renderPage: builds DOM for all tools
            // -------------------------
            function renderPage() {
                // When tools is falsy we show a "not authorized / no tools configured" state
                if (!tools) {
                    root.innerHTML = `<div class="admin-shell"><header>Admin Tools</header><div class="tools-area"><div class="not-admin">You are not authorized to view this page or no tools are configured.</div></div></div>`;
                    return;
                }

                // Build the shell and header programmatically (so re-render is simple)
                const shell = document.createElement('div'); shell.className = 'admin-shell';
                const header = document.createElement('header'); header.innerHTML = `<span style="pointer-events:none">Admin Tools</span>`;
                const addBtn = document.createElement('button'); addBtn.className = 'add-tool-btn'; addBtn.textContent = '+ Add'; addBtn.title = 'Add a new tool';
                addBtn.addEventListener('click', openEditor); // open editor on click
                header.appendChild(addBtn); shell.appendChild(header);

                const toolsArea = document.createElement('div'); toolsArea.className = 'tools-area';
                const grid = document.createElement('div'); grid.className = 'tool-grid';

                // For every tool, create a card with inputs and a submit button
                tools.forEach(tool => {
                    const card = document.createElement('div'); card.className = 'tool-card';
                    const title = document.createElement('div'); title.className = 'tool-title'; title.textContent = tool.name;
                    const body = document.createElement('div'); body.className = 'tool-body';
                    const inputEls = {}; // map of key->element for reading values later

                    // Build the input fields for the tool based on its inputs definition
                    (tool.inputs || []).forEach(inp => {
                        const fieldWrap = document.createElement('div');
                        const label = document.createElement('label'); label.textContent = inp.label || inp.key;
                        fieldWrap.appendChild(label);
                        let el;
                        // support textarea, select and default to <input>
                        if (inp.type === 'textarea') el = document.createElement('textarea');
                        else if (inp.type === 'select') {
                            el = document.createElement('select');
                            (inp.options || []).forEach(o => { const opt = document.createElement('option'); opt.value = o.value; opt.textContent = o.label; el.appendChild(opt); });
                        } else { el = document.createElement('input'); el.type = inp.type || 'text' }
                        el.placeholder = inp.placeholder || '';
                        el.dataset.key = inp.key;
                        // Clear any card message when user edits fields (simple UX nicety)
                        el.addEventListener('input', () => { const msg = card.querySelector('.card-message'); if (msg) msg.textContent = ''; });
                        fieldWrap.appendChild(el); body.appendChild(fieldWrap);
                        inputEls[inp.key] = el;
                    });

                    const spacer = document.createElement('div'); spacer.className = 'spacer';
                    card.appendChild(title); card.appendChild(body); card.appendChild(spacer);

                    // Submit button triggers onSubmit which shows confirm overlay
                    const submit = document.createElement('button'); submit.className = 'submit-btn'; submit.textContent = 'Submit';
                    submit.addEventListener('click', () => onSubmit(tool, inputEls, card));
                    card.appendChild(submit);

                    const msg = document.createElement('div'); msg.className = 'card-message'; card.appendChild(msg);

                    grid.appendChild(card);
                });

                toolsArea.appendChild(grid); shell.appendChild(toolsArea); root.innerHTML = ''; root.appendChild(shell);
            }

            // -------------------------
            // Submit flow for existing tools
            // -------------------------
            let currentConfirm = null; // holds pending confirm data (tool, values, card)

            // Called when user clicks "Submit" on a tool-card.
            // - collects values, validates non-empty, then shows confirmation overlay with values.
            function onSubmit(tool, inputEls, card) {
                const values = {};
                for (const k in inputEls) values[k] = inputEls[k].value;
                // basic required-field check: each field must be non-empty
                for (const k in values) { if (!String(values[k] || '').trim()) { const msg = card.querySelector('.card-message'); msg.textContent = `Please fill out ${k}`; return; } }
                const overlay = document.getElementById('saveConfirm');
                const body = overlay.querySelector('#saveConfirmBody');
                // show a short list of inputs (escaped) so user can confirm sensitive actions
                const paramList = Object.entries(values).map(([k, v]) => `<div><strong>${escapeHtml(k)}:</strong> ${escapeHtml(String(v).slice(0, 200))}</div>`).join('');
                body.innerHTML = `<div style="margin-bottom:8px">You are about to run <strong>${escapeHtml(tool.name)}</strong> with the following inputs:</div>${paramList}<div style="margin-top:8px;color:var(--text-dim);font-size:13px">Confirm to proceed.</div>`;
                overlay.querySelector('#confirmYes').textContent = "Comfirm";
                currentConfirm = { tool, values, card };
                overlay.classList.add('active');
            }

            // Cancel the confirm overlay
            document.getElementById('confirmNo')?.addEventListener('click', () => {
                document.getElementById('saveConfirm').classList.remove('active'); currentConfirm = null;
            });

            // Confirm "Yes" — execute the action function (if available) or show missing-function error
            document.getElementById('confirmYes')?.addEventListener('click', async () => {
                document.getElementById('saveConfirm').classList.remove('active');
                if (!currentConfirm) return;
                const { tool, values, card } = currentConfirm; currentConfirm = null; await executeAction(tool, values, card);
            });

            // executeAction: attempts to call a global function by tool.action with provided values
            async function executeAction(tool, values, card) {
                const msgEl = card.querySelector('.card-message');
                msgEl.textContent = 'Running…'; msgEl.classList.remove('error');
                try {
                    // Resolve the function from the global window using the action string
                    const fn = (typeof window[tool.action] === 'function') ? window[tool.action] : null;
                    let result;
                    if (typeof fn === 'function') result = await fn(Object.assign({}, values));
                    else result = { ok: false, message: 'Missing function "' + tool.action + '"' };
                    // interpret standard result shape { ok: boolean, message?: string }
                    if (result && !result.ok) { msgEl.classList.add('error'); msgEl.textContent = result.message || 'Failed.'; }
                    else { msgEl.textContent = result && result.message ? result.message : 'Success.'; }
                } catch (err) {
                    // catch runtime errors from the action function and show to user
                    console.error(err); msgEl.textContent = 'Error: ' + (err && err.message ? err.message : String(err)); msgEl.classList.add('error');
                }
            }

            // Simple HTML escape helper for injecting user values into confirm area safely
            function escapeHtml(str) { return String(str).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s])); }

            // ----- Editor logic -----
            // Grabbing DOM references used by the editor
            const editorOverlay = document.getElementById('editorOverlay');
            const editorAddInput = document.getElementById('editorAddInput');
            const inputsScroll = document.getElementById('inputsScroll');
            const editorName = document.getElementById('toolName');
            const editorAction = document.getElementById('toolAction');
            const editorCancel = document.getElementById('editorCancel');
            const editorSave = document.getElementById('editorSave');

            // openEditor(prefill)
            // - shows the editor overlay, optionally pre-populates fields for editing
            function openEditor(prefill) {
                editorName.value = (prefill && prefill.name) || '';
                editorAction.value = (prefill && prefill.action) || '';
                inputsScroll.innerHTML = '';
                // if prefill has inputs, append them; otherwise add one blank input card
                if (prefill && Array.isArray(prefill.inputs)) prefill.inputs.forEach(i => appendInputCard(i.key, i.label, i.type));
                else appendInputCard('', '', 'text');
                editorOverlay.classList.add('active'); editorOverlay.setAttribute('aria-hidden', 'false');
                // focus the name input after opening to speed up adding
                setTimeout(() => editorName.focus(), 50);
            }

            function closeEditor() { editorOverlay.classList.remove('active'); editorOverlay.setAttribute('aria-hidden', 'true'); }

            // Hook up editor buttons
            editorAddInput.addEventListener('click', () => appendInputCard('', '', 'text'));
            editorCancel.addEventListener('click', closeEditor);

            // appendInputCard creates a UI card for an input definition (label/key/type + remove)
            function appendInputCard(key = '', label = '', type = 'text') {
                const card = document.createElement('div'); card.className = 'input-card';
                // Label field
                const labelField = document.createElement('div');
                labelField.innerHTML = `<label>Label</label><input placeholder="Label" class="input-label" value="${escapeAttr(label)}" />`;
                // Key field (used as the param name)
                const keyField = document.createElement('div');
                keyField.innerHTML = `<label>Key</label><input placeholder="key" class="input-key" value="${escapeAttr(key)}" />`;
                // Type selector and remove button
                const typeRow = document.createElement('div'); typeRow.className = 'mini-row';
                const typeSelect = document.createElement('select');
                ['text', 'password', 'number', 'textarea', 'select'].forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; if (t === type) o.selected = true; typeSelect.appendChild(o); });
                const removeBtn = document.createElement('button'); removeBtn.className = 'remove-input'; removeBtn.textContent = 'Remove';
                removeBtn.addEventListener('click', () => { card.remove(); });
                typeRow.appendChild(typeSelect); typeRow.appendChild(removeBtn);
                card.appendChild(labelField); card.appendChild(keyField); card.appendChild(typeRow);
                inputsScroll.appendChild(card);
                // scroll to end so newly added card is visible
                setTimeout(() => { inputsScroll.scrollLeft = inputsScroll.scrollWidth; }, 50);
            }

            // simple attribute-escape for input values when injecting into innerHTML
            function escapeAttr(s) { if (!s) return ''; return String(s).replace(/"/g, '&quot;'); }

            // Save logic for the editor: validate and then show a confirm overlay before adding the tool
            editorSave.addEventListener('click', () => {
                const name = (editorName.value || '').trim();
                const action = (editorAction.value || '').trim();
                if (!name) return alert('Tool must have a name');
                if (!action) return alert('Tool must have an action function name');

                const inputs = [];
                const cards = Array.from(inputsScroll.querySelectorAll('.input-card'));
                for (const c of cards) {
                    const k = (c.querySelector('.input-key')?.value || '').trim();
                    const l = (c.querySelector('.input-label')?.value || '').trim();
                    const t = (c.querySelector('select')?.value || 'text');
                    if (!k || !l) return alert('Each input must have both a key and a label.');
                    inputs.push({ key: k, label: l, type: t });
                }

                // Show confirm (above editor) — re-uses saveConfirm modal
                const overlay = document.getElementById('saveConfirm');
                const body = overlay.querySelector('#saveConfirmBody');
                const paramList = inputs.map(i => `<div><strong>${escapeHtml(i.key)}</strong> (${escapeHtml(i.type)}) — ${escapeHtml(i.label)}</div>`).join('');
                body.innerHTML = `<div style="margin-bottom:8px">You're about to add tool <strong>${escapeHtml(name)}</strong> with action <code>${escapeHtml(action)}</code>.</div>${paramList}<div style="margin-top:8px;color:var(--text-dim);font-size:13px">Confirm to add.</div>`;
                overlay.querySelector('#confirmYes').textContent = "Add Tool";
                overlay.classList.add('active');

                // Replace confirmYes to avoid stacking multiple listeners if we open editor repeatedly.
                // We clone the node, replace it, then attach a fresh listener.
                const confirmYes = document.getElementById('confirmYes');
                const yesClone = confirmYes.cloneNode(true);
                confirmYes.parentNode.replaceChild(yesClone, confirmYes);
                yesClone.addEventListener('click', async () => {
                    overlay.classList.remove('active');
                    const tool = { name, inputs, action };
                    try {
                        await addTool(tool);
                        tools.push(tool);
                        renderPage();
                    } catch (e) {
                        console.error('addTool failed', e); alert('Failed to add tool: ' + (e && e.message ? e.message : String(e)));
                    }
                    closeEditor();
                });

                // For the cancel button inside the confirm modal, make sure it only runs once (avoid dup listeners)
                document.getElementById('confirmNo').addEventListener('click', () => overlay.classList.remove('active'), { once: true });
            });

            // allow Esc to close editor — simple global key handler
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (editorOverlay.classList.contains('active')) closeEditor();
                }
            });

        })();
    </script>
</body>

</html>