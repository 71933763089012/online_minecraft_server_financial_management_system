<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Minecraft Server — Main</title>
    <link rel="icon" href="/minecraft/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="./mainstyle.css">
    <link rel="stylesheet" type="text/css" href="index.css">

    <script src="./index.js"></script>

</head>

<body>

    <div class="wrap">
        <div class="card">

            <!-- Replaced static h1 with profile selector + heading -->
            <div style="width:100%; display:flex; flex-direction:column; align-items:center; gap:8px;">
                <h1 style="margin-bottom:6px">Profile</h1>

                <div class="profile-select" id="profileSelect">
                    <div class="profile-input" id="profileInputBox" role="combobox" aria-haspopup="listbox"
                        aria-expanded="false">
                        <input id="profileInput" placeholder="Search or choose profile" aria-label="Profile search"
                            autocomplete="off">
                        <div class="arrow" id="profileToggleBtn" title="Open profiles" aria-hidden="false">▾</div>
                    </div>

                    <div class="dropdown" id="profileDropdown" role="listbox" aria-label="Profiles list">
                        <!-- profile items will be injected here -->
                    </div>
                </div>
            </div>

            <div id="statusButton" class="status-button red" role="button" tabindex="0" aria-pressed="true">
                <div>
                    <div style="font-size:14px; opacity:0.85">Your access</div>
                    <div id="statusLabel" style="font-size:28px; margin-top:6px">INACTIVE</div>
                </div>
            </div>

            <div class="balance">
                <small>Your Balance</small>
                <div class="amount" id="userOwe">? DKK</div>
                <div class="estimate" id="estimatedNext">Next month: 0 DKK</div>
            </div>

            <div class="controls">
                <div>
                    <label for="maxCost">Maximum acceptable monthly cost (DKK)</label>
                    <input id="maxCost" type="number" min="0" value="10">
                </div>

                <div>
                    <label for="minPlayers">Minimum number of active players</label>
                    <input id="minPlayers" type="number" min="0" value="2">
                </div>
            </div>

            <div class="account" title="Account" role="link" onclick="location.href='/minecraft/account'"
                aria-label="Account">
                <img class="mc-face" src="/minecraft/avatar" alt="Minecraft Account" />
            </div>

        </div>
    </div>

    <script src="./profiledropdown.js"></script>

    <script>
        let avatarUrl = "/minecraft/avatar";
        (async function () {
            const account = await me()
            avatarUrl += "?u=" + encodeURIComponent(account.mcusername);
            document.querySelector(".mc-face").src = avatarUrl;
            document.getElementById("userOwe").textContent = `${-1 * account.owe} DKK`;
            if (await account.owe > 0) {
                document.getElementById("userOwe").style.color = "var(--accent-red)";
            } else {
                document.getElementById("userOwe").style.color = "var(--accent-green)";
            }
            const response = await fetch("/minecraft/availableProfiles", { method: "POST" })
            const availableProfiles = await response.json()
            if (account.activeProfiles) {
                for (const name of availableProfiles) {
                    if (account.activeProfiles.includes(name)) {
                        profiles.push({ name, enabled: true });
                    } else {
                        profiles.push({ name, enabled: false });
                    }
                }
            }

            if (!account.activeProfiles.includes(getCookie("selectedProfile"))) setCookie("selectedProfile", account.activeProfiles[0]);
            await updateProfileFields(getCookie("selectedProfile"));
        })().catch(err => {
            alert("Error loading profile: " + err.message);
            console.error(err);
        });

        function debounce(fn, delay) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn(...args), delay);
            };
        }

        const saveFrequency = 2000; // 2 seconds
        const debouncedSave = debounce(async () => {
            await saveSettings({
                max_cost: document.getElementById("maxCost").value,
                min_players: document.getElementById("minPlayers").value
            });
            await saveActiveProfiles(profiles.filter(p => p.enabled).map(p => p.name));
            unsavedChanges = false;
        }, saveFrequency);

        document.querySelectorAll(".controls input").forEach(input => {
            input.addEventListener("input", () => {
                unsavedChanges = true;
                debouncedSave();
            });
        });
    </script>

</body>

</html>